generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTH & USER MANAGEMENT
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLogin     DateTime?

  // Relationships
  roles         UserRole[]
  sessions      Session[]

  // Parent-specific
  parentProfile ParentProfile?

  // Student-specific
  studentProfile StudentProfile?

  // Teacher-specific
  teacherProfile TeacherProfile?

  // Activity tracking
  pageViews     PageView[]
  blogComments  BlogComment[]

  // LMS relationships
  knowledgeNodes KnowledgeNode[]
  teacherAssignments Assignment[] @relation("TeacherAssignments")

  @@index([email])
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false) // true for Public, Parent, Student, Teacher, Admin
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       UserRole[]
  permissions RolePermission[]

  @@index([name])
}

model Permission {
  id          String   @id @default(cuid())
  resource    String   // e.g., "blog", "invoice", "user"
  action      String   // e.g., "create", "read", "update", "delete"
  description String?
  createdAt   DateTime @default(now())

  roles       RolePermission[]

  @@unique([resource, action])
  @@index([resource, action])
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ============================================
// USER PROFILES
// ============================================

model ParentProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  phone       String?
  address     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  students    ParentStudent[]
  invoices    Invoice[]
}

model StudentProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  dateOfBirth DateTime?
  grade       String?
  school      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  parents           ParentStudent[]
  assignments       Assignment[]
  progress          StudentProgress[]
  assignmentSubmissions AssignmentSubmission[]
}

model TeacherProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  bio         String?
  specialization String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ParentStudent {
  id        String   @id @default(cuid())
  parentId  String
  studentId String
  createdAt DateTime @default(now())

  parent  ParentProfile  @relation(fields: [parentId], references: [id], onDelete: Cascade)
  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([parentId, studentId])
  @@index([parentId])
  @@index([studentId])
}

// ============================================
// PUBLIC LAYER
// ============================================

model Page {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  content     String   @db.Text
  isDraft     Boolean  @default(false)
  metaTitle   String?
  metaDescription String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?

  views       PageView[]

  @@index([slug])
}

model Blog {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  excerpt     String?
  content     String   @db.Text
  coverImage  String?
  isDraft     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?

  comments    BlogComment[]
  views       PageView[]

  @@index([slug])
  @@index([publishedAt])
}

model BlogComment {
  id        String   @id @default(cuid())
  blogId    String
  userId    String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  blog Blog @relation(fields: [blogId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([blogId])
  @@index([userId])
}

model Course {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String   @db.Text
  level       String?  // e.g., "Beginner", "Intermediate", "Advanced"
  duration    String?
  ageRange    String?
  price       Float?
  topics      String[] // Array of topic strings
  image       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([slug])
}

model Activity {
  id          String   @id @default(cuid())
  title       String
  description String   @db.Text
  date        DateTime
  image       String?
  category    String?  // e.g., "tournament", "event", "achievement"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
  @@index([category])
}

model ContactSubmission {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  message   String   @db.Text
  status    String   @default("new") // new, read, replied, archived
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}

// ============================================
// PAYMENT LAYER
// ============================================

model Invoice {
  id          String   @id @default(cuid())
  invoiceNumber String @unique
  parentId    String
  status      String   @default("unpaid") // unpaid, paid, overdue, cancelled
  dueDate     DateTime
  paidDate    DateTime?
  subtotal    Float
  tax         Float    @default(0)
  total       Float
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parent      ParentProfile @relation(fields: [parentId], references: [id], onDelete: Cascade)
  items       InvoiceItem[]

  @@index([parentId])
  @@index([status])
  @@index([dueDate])
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int      @default(1)
  unitPrice   Float
  total       Float
  createdAt   DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

// ============================================
// LMS LAYER
// ============================================

model KnowledgeNode {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  nodeType    String   @default("markdown") // markdown, mindmap, graph
  authorId    String
  folderId    String?
  tags        String[]
  attachments String[]
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  author         User                  @relation(fields: [authorId], references: [id], onDelete: Cascade)
  folder         Folder?               @relation(fields: [folderId], references: [id])
  relationships  NodeRelationship[]    @relation("NodeFrom")
  relatedTo      NodeRelationship[]    @relation("NodeTo")
  studentProgress StudentProgress[]

  @@index([authorId])
  @@index([folderId])
  @@index([isPublished])
}

model Folder {
  id        String   @id @default(cuid())
  name      String
  parentId  String?
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parent   Folder?         @relation("FolderHierarchy", fields: [parentId], references: [id])
  children Folder[]        @relation("FolderHierarchy")
  nodes    KnowledgeNode[]

  @@index([parentId])
}

model NodeRelationship {
  id        String   @id @default(cuid())
  fromId    String
  toId      String
  type      String   @default("related") // related, prerequisite, continuation, reference
  createdAt DateTime @default(now())

  from KnowledgeNode @relation("NodeFrom", fields: [fromId], references: [id], onDelete: Cascade)
  to   KnowledgeNode @relation("NodeTo", fields: [toId], references: [id], onDelete: Cascade)

  @@unique([fromId, toId])
  @@index([fromId])
  @@index([toId])
}

model Assignment {
  id          String   @id @default(cuid())
  title       String
  description String   @db.Text
  dueDate     DateTime
  points      Int      @default(100)
  teacherId   String
  studentId   String?  // null = assigned to all students
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  teacher     User                     @relation("TeacherAssignments", fields: [teacherId], references: [id], onDelete: Cascade)
  student     StudentProfile?          @relation(fields: [studentId], references: [id])
  submissions AssignmentSubmission[]

  @@index([teacherId])
  @@index([studentId])
  @@index([dueDate])
}

model AssignmentSubmission {
  id           String   @id @default(cuid())
  assignmentId String
  studentId    String
  content      String   @db.Text
  attachments  String[]
  status       String   @default("submitted") // submitted, graded, returned
  grade        Int?
  feedback     String?  @db.Text
  submittedAt  DateTime @default(now())
  gradedAt     DateTime?

  assignment Assignment     @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@index([status])
}

model StudentProgress {
  id        String   @id @default(cuid())
  studentId String
  nodeId    String
  status    String   @default("not_started") // not_started, in_progress, completed
  progress  Int      @default(0) // 0-100
  lastViewed DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  node    KnowledgeNode  @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  @@unique([studentId, nodeId])
  @@index([studentId])
  @@index([nodeId])
}

// ============================================
// ANALYTICS & MONITORING
// ============================================

model PageView {
  id        String   @id @default(cuid())
  path      String
  userId    String?
  userRole  String?
  pageId    String?
  blogId    String?
  viewedAt  DateTime @default(now())
  sessionId String?

  user User? @relation(fields: [userId], references: [id])
  page Page? @relation(fields: [pageId], references: [id])
  blog Blog? @relation(fields: [blogId], references: [id])

  @@index([path])
  @@index([userId])
  @@index([viewedAt])
}

model SystemMetric {
  id        String   @id @default(cuid())
  metric    String   // cpu, memory, disk, network, dbConnections
  value     Float
  unit      String   // percent, MB, GB, count
  timestamp DateTime @default(now())

  @@index([metric, timestamp])
}
